# 事件循环

[toc]

## 前导知识

- JS运行的环境被称为宿主环境,

- **执行栈**:存放各个函数的执行环境，JS引擎永远执行执行栈的最顶层.详情看<a href="./执行期上下文.md">执行期上下文</a>
- **异步函数**:某些函数不立即执行，而是等到某一个时机才执行，比如定时器。异步函数的执行时机是由宿主环境控制的


## 执行机制

+ 浏览器宿主环境有5个线程:
  - JS引擎线程 ： 负责执行执行栈最顶层的代码
  - GUI线程： 负责渲染页面(DOMContentLoaded,onLoad)
  - 定时器线程 ：主管定时器
  - 事件监听线程： 监听事件
  - 网络线程:   负责网络通信

当上面的线程发生某些事时，如果该线程发现这个件事情有处理程序，会将该处理程序加入一个执行队列中，当主线程执行栈为空后，会循环扫描执行队列并执行其中的程序,这个过程就是事件循环

```javascript
        setTimeout(_=>console.log('hello'),30);
        console.log('world')
        这段代码中，JS引擎遇到一个定时器，将其交给定时器线程，然后继续执行后续的代码。
        定时器线程待到定时结束后，将其推入执行队列之中等待执行。
        主线程在输出world后执行栈为空，于是扫描执行队列，发现了定时器线程推入的代码并执行，打印出'hello'
```

事件队列在不同的宿主环境中有所差异,大部分宿主环境会将实践队列进行细分。
在浏览器宿主中，事件队列分为宏任务和微任务

**宏任务**:macroTask,计时器回调，事件回调，http回调等绝大部分异步函数进入宏任务
**微任务**：microTask,Promise产生的回调进入微任务

微任务有优先执行权!
